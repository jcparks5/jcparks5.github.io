<!doctype HTML>
<html>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<script src="js/aframe.min.js"></script>
<script src="js/aframe-ar.js"></script>
<body style="margin: 0px; overflow: hidden;">

<script>

let markerVisible = { "TH": false, "WF0": false};
let timer = 180;
let resources = 0;
let wheatFields = 0;
let lastCall = 0;

AFRAME.registerComponent('registerevents', {
    init: function ()
    {
        let marker = this.el;

        marker.addEventListener('markerFound', function() {
            markerVisible[ marker.id ] = true;
            // console.log( markerVisible );
        });

        marker.addEventListener('markerLost', function() {
            markerVisible[ marker.id ] = false;
            // console.log( markerVisible );
        });
    }
});

AFRAME.registerComponent('loop',
{
    init: function()
    {

    },

    tick: function (time, deltaTime)
    {

        document.getElementById("time_left").color = "blue";
        // for convenience
        let mv = markerVisible, r = "TH", y = "WF0";
        if (timer == 180)
        {
          if ( mv[r] && mv[y])
          {
            timer--;
            document.getElementById("time_left").setAttribute("value", timer);
            document.getElementById("money").setAttribute("value", resources);
            wheatFields = 1;
          }
        }
        if((timer) > 0 && (timer < 180))
        {
          if (new Date()-1000 > lastCall)
          {
            resources += wheatFields;
            timer--;
            document.getElementById("time_left").setAttribute("value", timer);
            document.getElementById("money").setAttribute("value", resources);
            lastCall = new Date();
          }
        }
        console.log(timer);
    }
});

</script>

<a-scene embedded vr-mode-ui="enabled: false;" arjs="debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">

    <a-assets>
        <a-asset-item id="field" src="models/wheat.gltf"></a-asset-item>
        <a-asset-item id="base" src="models/house.gltf"></a-asset-item>
	</a-assets>


    <a-marker type="barcode" value="0" id="WF0" registerevents>
      <a-text id="money" value="hello" font="fonts/Exo2Bold.fnt" position="0 2.1 0" color="red" rotation="-90 0 0" align="center" scale="2 2 2"></a-text>
        <a-entity   position="0 0 0"
                    rotation="0 0 0"
                    scale="0.01 0.01 0.01"
                    gltf-model="#field" >
        </a-entity>
    </a-marker>

    <a-marker type="pattern" url="data/hiro.patt" id="TH" registerevents>
      <a-text id="time_left" value="hello" font="fonts/Exo2Bold.fnt" position="0 2.1 0" color="blue" rotation="-90 0 0" align="center" scale="2 2 2"></a-text>
        <a-entity   position="0 0 0"
                    rotation="0 0 0"
                    scale="0.05 0.05 0.05"
                    gltf-model="#base" >
        </a-entity>
    </a-marker>

    <a-entity camera></a-entity>
    <a-entity loop></a-entity>

</a-scene>
</body>
</html>
